(ns pids.parser (:require [clojure.string :as cljstr]))

(def manifest ["#EXTM3U"
"#EXT-X-INDEPENDENT-SEGMENTS"
"#EXT-X-MEDIA:TYPE=CLOSED-CAPTIONS,GROUP-ID='cc',NAME='Closed Captions',DEFAULT=YES,AUTOSELECT=YES,LANGUAGE='ENG',INSTREAM-ID='CC1'"
"#EXT-X-STREAM-INF:BANDWIDTH=8801028,AVERAGE-BANDWIDTH=7259068,CODECS='avc1.640028,mp4a.40.2',RESOLUTION=1920x1080,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_0_7064000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=8801028,AVERAGE-BANDWIDTH=7259068,CODECS='avc1.640028,mp4a.40.2',RESOLUTION=1920x1080,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_0_7064000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=5172258,AVERAGE-BANDWIDTH=4193668,CODECS='avc1.4D4020,mp4a.40.2',RESOLUTION=1280x720,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_1_4064000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=5172258,AVERAGE-BANDWIDTH=4193668,CODECS='avc1.4D4020,mp4a.40.2',RESOLUTION=1280x720,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_1_4064000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=2947032,AVERAGE-BANDWIDTH=2354428,CODECS='avc1.4D401F,mp4a.40.2',RESOLUTION=1024x576,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_2_2264000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=2947032,AVERAGE-BANDWIDTH=2354428,CODECS='avc1.4D401F,mp4a.40.2',RESOLUTION=1024x576,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_2_2264000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=1937933,AVERAGE-BANDWIDTH=1536988,CODECS='avc1.4D401E,mp4a.40.2',RESOLUTION=768x432,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_3_1464000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=1937933,AVERAGE-BANDWIDTH=1536988,CODECS='avc1.4D401E,mp4a.40.2',RESOLUTION=768x432,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_3_1464000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=1296764,AVERAGE-BANDWIDTH=1026088,CODECS='avc1.4D401E,mp4a.40.2',RESOLUTION=640x360,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_4_964000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=1296764,AVERAGE-BANDWIDTH=1026088,CODECS='avc1.4D401E,mp4a.40.2',RESOLUTION=640x360,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_4_964000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=906120,AVERAGE-BANDWIDTH=719548,CODECS='avc1.42E015,mp4a.40.2',RESOLUTION=512x288,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_5_664000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=906120,AVERAGE-BANDWIDTH=719548,CODECS='avc1.42E015,mp4a.40.2',RESOLUTION=512x288,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_5_664000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=508358,AVERAGE-BANDWIDTH=413008,CODECS='avc1.42E00D,mp4a.40.2',RESOLUTION=384x216,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
"http://sprtott2-i.akamaihd.net/hls/live/222320/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_6_364000_vod.m3u8"
"#EXT-X-STREAM-INF:BANDWIDTH=508358,AVERAGE-BANDWIDTH=413008,CODECS='avc1.42E00D,mp4a.40.2',RESOLUTION=384x216,FRAME-RATE=30,CLOSED-CAPTIONS='cc'"
               "http://sprtott2-i.akamaihd.net/hls/live/222320-b/NBC-Sports1205103712-ua/OTT2/OTT2_VIDEO_6_364000_vod.m3u8"])


(defn constructUrl [manifestUrl text]
  (if (and manifestUrl text)
  (cond (re-matches #"^http.*" text) text
        (= (first text) "/")
          (str (aget (new js/URL manifestUrl) "origin") text)
        :else (str (cljstr/join "/"
              (pop (cljstr/split manifestUrl "/"))) "/" text)) nil))

(defn isLive [str]
  (not (re-find #"ENDLIST" str)))

(defn getStream [manifestVector]
  (first (filter #(re-matches #".+\.m3u8" %) manifestVector)))
